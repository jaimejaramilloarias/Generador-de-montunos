import{M as w}from"./midi-BxdmwAZx.js";import{a as M,n as x,r as B}from"./index-D6wmeY1P.js";let m=null,k=0;const u=new Map;function I(){return m||(m=new Worker(new URL("/Generador-de-montunos/assets/originalWorker-DQ1AG9_s.js",import.meta.url),{type:"module"}),m.onmessage=e=>{const n=e.data,r=u.get(n.id);r&&(u.delete(n.id),n.success?r.resolve(n.result):r.reject(new Error(n.error)))},m.onerror=e=>{const n=new Error(e.message||"Fallo en el generador de montunos.");u.forEach(({reject:r})=>r(n)),u.clear()}),m}function R(e,n){const r=I(),i=++k,t={id:i,type:"generate",payload:{...e,baseUrl:n}};return new Promise((c,l)=>{u.set(i,{resolve:c,reject:l}),r.postMessage(t)})}const T="TVRoZAAAAAYAAAABAeBNVHJrAAAPqwD/IAEAAP8DDnNhbHNhXzItM19yb290AP8EEFN0ZWlud2F5IEQgR3JhbmQA/1gEBAIYCAD/WQIAAAD/VAUhAAAAAACQ",C={midi_base64:T.replace(/\n/g,""),modo_tag:"Tradicional (fallback)",clave_tag:"Clave 2-3 (fallback)",max_eighths:16,reference_files:["fallback/salsa_2-3_root_A.mid"]},F="backend/reference_midi_loops";async function U(e){const n="/Generador-de-montunos/",r=typeof e.seed=="number"&&Number.isFinite(e.seed)?e.seed:null,i=M(x(e.progressionInput)),t=B(e.chords,e.inversionDefault),c=e.chords.map((o,s)=>{var p;return{index:o.index,modo:o.modo,armonizacion:o.armonizacion,octavacion:o.octavacion,inversion:((p=t[s])==null?void 0:p.inversion)??o.inversion??null}}),l=60/e.bpm,f=(e.manualEdits??[]).map(o=>({type:o.type,start:o.startBeats*l,end:(o.startBeats+o.durationBeats)*l,pitch:o.pitch}));let a;try{a=await R({progression:i,clave:e.clave,modoDefault:e.modoDefault,armonizacionDefault:e.armonizacionDefault,variation:e.variation,inversionDefault:e.inversionDefault,octavacionDefault:e.octavacionDefault,bpm:e.bpm,seed:r,chords:c,referenceRoot:F,manualEdits:f},n)}catch(o){console.warn("Fallo al generar el montuno con Pyodide, usando resultado de respaldo.",o),a={...C,modo_tag:`${e.modoDefault} (respaldo)`,clave_tag:`${e.clave} (respaldo)`}}const d=N(a.midi_base64),v=d.buffer.slice(d.byteOffset,d.byteOffset+d.byteLength),A=new w.Midi(v),h=A.header.ppq||480,g=[];A.tracks.forEach(o=>{o.notes.forEach(s=>{if(s.midi<=0)return;const p=s.ticks/h,D=s.durationTicks/h;g.push({time:p,duration:D,midi:s.midi,velocity:s.velocity})})}),g.sort((o,s)=>o.time===s.time?o.midi-s.midi:o.time-s.time);const b=P(g),_=60/e.bpm/2,y=a.max_eighths*_,E=Math.max(1,Math.ceil(a.max_eighths/8));return{events:b,lengthBars:E,bpm:e.bpm,durationSeconds:y,midiData:d,modoTag:a.modo_tag,claveTag:a.clave_tag,maxEighths:a.max_eighths,referenceFiles:a.reference_files}}function N(e){const n=globalThis.atob(e),r=new Uint8Array(n.length);for(let i=0;i<n.length;i+=1)r[i]=n.charCodeAt(i);return r}function P(e){const n=[],r=new Map;return e.forEach(i=>{const t={...i},c=r.get(t.midi);if(c){const l=c.time+c.duration;if(t.time<l){const f=Math.max(0,t.time-c.time);if(f<=1e-6){const a=n.indexOf(c);a!==-1&&n.splice(a,1),r.delete(t.midi)}else c.duration=f}}t.duration>0&&(n.push(t),r.set(t.midi,t))}),n.filter(i=>i.duration>1e-6)}export{U as generateMontuno};
