import{M as w}from"./midi-BxdmwAZx.js";import{a as D,n as M}from"./index-CkiZbEhy.js";let m=null,x=0;const u=new Map;function B(){return m||(m=new Worker(new URL("/Generador-de-montunos/assets/originalWorker-Q-WnaiR1.js",import.meta.url),{type:"module"}),m.onmessage=e=>{const n=e.data,r=u.get(n.id);r&&(u.delete(n.id),n.success?r.resolve(n.result):r.reject(new Error(n.error)))},m.onerror=e=>{const n=new Error(e.message||"Fallo en el generador de montunos.");u.forEach(({reject:r})=>r(n)),u.clear()}),m}function k(e,n){const r=B(),t=++x,i={id:t,type:"generate",payload:{...e,baseUrl:n}};return new Promise((s,d)=>{u.set(t,{resolve:s,reject:d}),r.postMessage(i)})}const R="TVRoZAAAAAYAAAABAeBNVHJrAAAPqwD/IAEAAP8DDnNhbHNhXzItM19yb290AP8EEFN0ZWlud2F5IEQgR3JhbmQA/1gEBAIYCAD/WQIAAAD/VAUhAAAAAACQ",T={midi_base64:R.replace(/\n/g,""),modo_tag:"Tradicional (fallback)",clave_tag:"Clave 2-3 (fallback)",max_eighths:16,reference_files:["fallback/salsa_2-3_root_A.mid"]},I="backend/reference_midi_loops";async function z(e){const n="/Generador-de-montunos/",r=typeof e.seed=="number"&&Number.isFinite(e.seed)?e.seed:null,t=D(M(e.progressionInput)),i=e.chords.map(o=>({index:o.index,modo:o.modo,armonizacion:o.armonizacion,inversion:o.inversion??null})),s=60/e.bpm,d=(e.manualEdits??[]).map(o=>({type:o.type,start:o.startBeats*s,end:(o.startBeats+o.durationBeats)*s,pitch:o.pitch}));let a;try{a=await k({progression:t,clave:e.clave,modoDefault:e.modoDefault,armonizacionDefault:e.armonizacionDefault,variation:e.variation,inversionDefault:e.inversionDefault,bpm:e.bpm,seed:r,chords:i,referenceRoot:I,manualEdits:d},n)}catch(o){console.warn("Fallo al generar el montuno con Pyodide, usando resultado de respaldo.",o),a={...T,modo_tag:`${e.modoDefault} (respaldo)`,clave_tag:`${e.clave} (respaldo)`}}const l=C(a.midi_base64),A=l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength),p=new w.Midi(A),g=p.header.ppq||480,f=[];p.tracks.forEach(o=>{o.notes.forEach(c=>{if(c.midi<=0)return;const E=c.ticks/g,_=c.durationTicks/g;f.push({time:E,duration:_,midi:c.midi,velocity:c.velocity})})}),f.sort((o,c)=>o.time===c.time?o.midi-c.midi:o.time-c.time);const h=F(f),b=60/e.bpm/2,v=a.max_eighths*b,y=Math.max(1,Math.ceil(a.max_eighths/8));return{events:h,lengthBars:y,bpm:e.bpm,durationSeconds:v,midiData:l,modoTag:a.modo_tag,claveTag:a.clave_tag,maxEighths:a.max_eighths,referenceFiles:a.reference_files}}function C(e){const n=globalThis.atob(e),r=new Uint8Array(n.length);for(let t=0;t<n.length;t+=1)r[t]=n.charCodeAt(t);return r}function F(e){const n=[],r=new Map;return e.forEach(t=>{const i={...t},s=r.get(i.midi);if(s){const d=s.time+s.duration;if(i.time<d){const a=Math.max(0,i.time-s.time);if(a<=1e-6){const l=n.indexOf(s);l!==-1&&n.splice(l,1),r.delete(i.midi)}else s.duration=a}}i.duration>0&&(n.push(i),r.set(i.midi,i))}),n.filter(t=>t.duration>1e-6)}export{z as generateMontuno};
