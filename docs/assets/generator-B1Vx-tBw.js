import{M}from"./midi-BxdmwAZx.js";import{a as R,n as D,r as x}from"./index-BF4NasRG.js";let m=null,B=0;const u=new Map;function N(){return m||(m=new Worker(new URL(""+new URL("originalWorker-DUMTYpXG.js",import.meta.url).href,import.meta.url),{type:"module"}),m.onmessage=e=>{const n=e.data,t=u.get(n.id);t&&(u.delete(n.id),n.success?t.resolve(n.result):t.reject(new Error(n.error)))},m.onerror=e=>{const n=new Error(e.message||"Fallo en el generador de montunos.");u.forEach(({reject:t})=>t(n)),u.clear()}),m}function k(e,n){const t=N(),o=++B,i={id:o,type:"generate",payload:{...e,baseUrl:n}};return new Promise((c,l)=>{u.set(o,{resolve:c,reject:l}),t.postMessage(i)})}const I="TVRoZAAAAAYAAAABAeBNVHJrAAAPqwD/IAEAAP8DDnNhbHNhXzItM19yb290AP8EEFN0ZWlud2F5IEQgR3JhbmQA/1gEBAIYCAD/WQIAAAD/VAUhAAAAAACQ",T={midi_base64:I.replace(/\n/g,""),modo_tag:"Salsa (fallback)",clave_tag:"Clave 2-3 (fallback)",max_eighths:16,reference_files:["fallback/salsa_2-3_root_A.mid"]},C="backend/reference_midi_loops";async function L(e){const n="./",t=O(e.seed),o=R(D(e.progressionInput)),i=x(e.chords,e.inversionDefault),c=e.chords.map((r,s)=>{var p;return{index:r.index,octavacion:r.octavacion,inversion:((p=i[s])==null?void 0:p.inversion)??r.inversion??null,registerOffset:r.registerOffset,approachNotes:r.approachNotes}}),l=60/e.bpm,f=(e.manualEdits??[]).map(r=>({type:r.type,start:r.startBeats*l,end:(r.startBeats+r.durationBeats)*l,pitch:r.pitch}));let a;try{a=await k({progression:o,clave:e.clave,variation:e.variation,inversionDefault:e.inversionDefault,octavacionDefault:e.octavacionDefault,bpm:e.bpm,seed:t,chords:c,referenceRoot:C,manualEdits:f},n)}catch(r){console.warn("Fallo al generar el montuno con Pyodide, usando resultado de respaldo.",r),a={...T,modo_tag:"Salsa (respaldo)",clave_tag:`${e.clave} (respaldo)`}}const d=F(a.midi_base64),v=d.buffer.slice(d.byteOffset,d.byteOffset+d.byteLength),h=new M.Midi(v),A=h.header.ppq||480,g=[];h.tracks.forEach(r=>{r.notes.forEach(s=>{if(s.midi<=0)return;const p=s.ticks/A,w=s.durationTicks/A;g.push({time:p,duration:w,midi:s.midi,velocity:s.velocity})})}),g.sort((r,s)=>r.time===s.time?r.midi-s.midi:r.time-s.time);const b=U(g),y=60/e.bpm/2,E=a.max_eighths*y,_=Math.max(1,Math.ceil(a.max_eighths/8));return{events:b,lengthBars:_,bpm:e.bpm,durationSeconds:E,midiData:d,modoTag:a.modo_tag,claveTag:a.clave_tag,maxEighths:a.max_eighths,referenceFiles:a.reference_files}}function F(e){const n=globalThis.atob(e),t=new Uint8Array(n.length);for(let o=0;o<n.length;o+=1)t[o]=n.charCodeAt(o);return t}function U(e){const n=[],t=new Map;return e.forEach(o=>{const i={...o},c=t.get(i.midi);if(c){const l=c.time+c.duration;if(i.time<l){const f=Math.max(0,i.time-c.time);if(f<=1e-6){const a=n.indexOf(c);a!==-1&&n.splice(a,1),t.delete(i.midi)}else c.duration=f}}i.duration>0&&(n.push(i),t.set(i.midi,i))}),n.filter(o=>o.duration>1e-6)}function O(e){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof crypto<"u"&&"getRandomValues"in crypto){const n=new Uint32Array(1);return crypto.getRandomValues(n),Number(n[0])}return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}export{L as generateMontuno};
