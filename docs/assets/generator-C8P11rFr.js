import{M as w}from"./midi-BxdmwAZx.js";import{a as B,n as M,r as x}from"./index-DmXmj_BW.js";let d=null,k=0;const u=new Map;function R(){return d||(d=new Worker(new URL(""+new URL("originalWorker-P2nX78ga.js",import.meta.url).href,import.meta.url),{type:"module"}),d.onmessage=e=>{const o=e.data,r=u.get(o.id);r&&(u.delete(o.id),o.success?r.resolve(o.result):r.reject(new Error(o.error)))},d.onerror=e=>{const o=new Error(e.message||"Fallo en el generador de montunos.");u.forEach(({reject:r})=>r(o)),u.clear()}),d}function I(e,o){const r=R(),i=++k,t={id:i,type:"generate",payload:{...e,baseUrl:o}};return new Promise((c,l)=>{u.set(i,{resolve:c,reject:l}),r.postMessage(t)})}const N="TVRoZAAAAAYAAAABAeBNVHJrAAAPqwD/IAEAAP8DDnNhbHNhXzItM19yb290AP8EEFN0ZWlud2F5IEQgR3JhbmQA/1gEBAIYCAD/WQIAAAD/VAUhAAAAAACQ",T={midi_base64:N.replace(/\n/g,""),modo_tag:"Tradicional (fallback)",clave_tag:"Clave 2-3 (fallback)",max_eighths:16,reference_files:["fallback/salsa_2-3_root_A.mid"]},C="backend/reference_midi_loops";async function L(e){const o="./",r=typeof e.seed=="number"&&Number.isFinite(e.seed)?e.seed:null,i=B(M(e.progressionInput)),t=x(e.chords,e.inversionDefault),c=e.chords.map((n,s)=>{var p;return{index:n.index,modo:n.modo,armonizacion:n.armonizacion,octavacion:n.octavacion,inversion:((p=t[s])==null?void 0:p.inversion)??n.inversion??null,approachNotes:n.approachNotes.split(",").map(h=>h.trim()).filter(Boolean)}}),l=60/e.bpm,f=(e.manualEdits??[]).map(n=>({type:n.type,start:n.startBeats*l,end:(n.startBeats+n.durationBeats)*l,pitch:n.pitch}));let a;try{a=await I({progression:i,clave:e.clave,modoDefault:e.modoDefault,armonizacionDefault:e.armonizacionDefault,variation:e.variation,inversionDefault:e.inversionDefault,octavacionDefault:e.octavacionDefault,bpm:e.bpm,seed:r,chords:c,referenceRoot:C,manualEdits:f},o)}catch(n){console.warn("Fallo al generar el montuno con Pyodide, usando resultado de respaldo.",n),a={...T,modo_tag:`${e.modoDefault} (respaldo)`,clave_tag:`${e.clave} (respaldo)`}}const m=P(a.midi_base64),b=m.buffer.slice(m.byteOffset,m.byteOffset+m.byteLength),A=new w.Midi(b),v=A.header.ppq||480,g=[];A.tracks.forEach(n=>{n.notes.forEach(s=>{if(s.midi<=0)return;const p=s.ticks/v,h=s.durationTicks/v;g.push({time:p,duration:h,midi:s.midi,velocity:s.velocity})})}),g.sort((n,s)=>n.time===s.time?n.midi-s.midi:n.time-s.time);const y=F(g),E=60/e.bpm/2,_=a.max_eighths*E,D=Math.max(1,Math.ceil(a.max_eighths/8));return{events:y,lengthBars:D,bpm:e.bpm,durationSeconds:_,midiData:m,modoTag:a.modo_tag,claveTag:a.clave_tag,maxEighths:a.max_eighths,referenceFiles:a.reference_files}}function P(e){const o=globalThis.atob(e),r=new Uint8Array(o.length);for(let i=0;i<o.length;i+=1)r[i]=o.charCodeAt(i);return r}function F(e){const o=[],r=new Map;return e.forEach(i=>{const t={...i},c=r.get(t.midi);if(c){const l=c.time+c.duration;if(t.time<l){const f=Math.max(0,t.time-c.time);if(f<=1e-6){const a=o.indexOf(c);a!==-1&&o.splice(a,1),r.delete(t.midi)}else c.duration=f}}t.duration>0&&(o.push(t),r.set(t.midi,t))}),o.filter(i=>i.duration>1e-6)}export{L as generateMontuno};
